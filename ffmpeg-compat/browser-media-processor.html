<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser FFmpeg Media Processor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .compatibility-check {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 5px solid #28a745;
        }

        .compatibility-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .compatibility-icon {
            width: 24px;
            height: 24px;
            margin-right: 15px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .compatible { background: #28a745; }
        .incompatible { background: #dc3545; }

        .upload-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            border: 3px dashed #dee2e6;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #4facfe;
            background: #e3f2fd;
        }

        .upload-section.dragover {
            border-color: #4facfe;
            background: #e3f2fd;
            transform: scale(1.02);
        }

        .file-input {
            display: none;
        }

        .upload-button {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }

        .upload-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .format-selection {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .format-option {
            position: relative;
        }

        .format-option input[type="radio"] {
            position: absolute;
            opacity: 0;
        }

        .format-label {
            display: inline-block;
            padding: 10px 20px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .format-option input[type="radio"]:checked + .format-label {
            background: #4facfe;
            color: white;
            border-color: #4facfe;
        }

        .progress-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            display: none;
        }

        .progress-section.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .memory-usage {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .memory-bar {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .memory-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
            border-radius: 5px;
            transition: width 0.3s ease;
        }

        .memory-fill.warning {
            background: linear-gradient(90deg, #ffc107 0%, #fd7e14 100%);
        }

        .memory-fill.danger {
            background: linear-gradient(90deg, #dc3545 0%, #e83e8c 100%);
        }

        .results-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .file-info {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .file-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4facfe;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 5px;
        }

        .download-button {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .download-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 30px 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .content {
                padding: 20px;
            }
            
            .format-selection {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé¨ Browser FFmpeg Processor</h1>
            <p>Professional media processing powered by WebAssembly</p>
        </div>

        <div class="content">
            <!-- Compatibility Check -->
            <div class="compatibility-check">
                <h3>üîç Browser Compatibility Check</h3>
                <div id="compatibilityResults"></div>
            </div>

            <!-- Upload Section -->
            <div class="upload-section" id="uploadSection">
                <h3>üìÅ Upload Media File</h3>
                <p>Drag and drop your file here or click to browse</p>
                <input type="file" id="fileInput" class="file-input" accept="video/*,audio/*,image/*">
                <button class="upload-button" onclick="document.getElementById('fileInput').click()">
                    Choose File
                </button>
                
                <div class="format-selection">
                    <div class="format-option">
                        <input type="radio" id="formatWebm" name="outputFormat" value="webm" checked>
                        <label for="formatWebm" class="format-label">WebM</label>
                    </div>
                    <div class="format-option">
                        <input type="radio" id="formatMp4" name="outputFormat" value="mp4">
                        <label for="formatMp4" class="format-label">MP4</label>
                    </div>
                    <div class="format-option">
                        <input type="radio" id="formatMp3" name="outputFormat" value="mp3">
                        <label for="formatMp3" class="format-label">MP3</label>
                    </div>
                    <div class="format-option">
                        <input type="radio" id="formatOpus" name="outputFormat" value="opus">
                        <label for="formatOpus" class="format-label">Opus</label>
                    </div>
                </div>

                <button class="upload-button" id="processButton" disabled>
                    üöÄ Process Media
                </button>
            </div>

            <!-- Progress Section -->
            <div class="progress-section" id="progressSection">
                <h3>‚ö° Processing Media</h3>
                <div class="progress-info">
                    <span id="progressStatus">Initializing...</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>

                <!-- Memory Usage -->
                <div class="memory-usage">
                    <h4>üíæ Memory Usage</h4>
                    <div class="progress-info">
                        <span>Used: <span id="memoryUsed">0</span> MB</span>
                        <span>Total: <span id="memoryTotal">256</span> MB</span>
                    </div>
                    <div class="memory-bar">
                        <div class="memory-fill" id="memoryFill"></div>
                    </div>
                </div>

                <!-- Processing Stats -->
                <div class="file-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="processingTime">0</div>
                        <div class="stat-label">Processing Time (ms)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="peakMemory">0</div>
                        <div class="stat-label">Peak Memory (MB)</div>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div class="error-message" id="errorMessage"></div>

            <!-- Results Section -->
            <div class="results-section" id="resultsSection">
                <h3>‚úÖ Processing Complete!</h3>
                
                <div class="file-info">
                    <h4>üìä File Information</h4>
                    <p><strong>Original Size:</strong> <span id="originalSize">-</span></p>
                    <p><strong>Processed Size:</strong> <span id="processedSize">-</span></p>
                    <p><strong>Compression Ratio:</strong> <span id="compressionRatio">-</span></p>
                </div>

                <div class="file-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="finalProcessingTime">0</div>
                        <div class="stat-label">Total Time (ms)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="finalPeakMemory">0</div>
                        <div class="stat-label">Peak Memory (MB)</div>
                    </div>
                </div>

                <button class="download-button" id="downloadButton">
                    üì• Download Processed File
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { BrowserFFmpeg, BrowserMediaUtils } from './browser-ffmpeg-integration.js';

        class MediaProcessor {
            constructor() {
                this.ffmpeg = null;
                this.currentFile = null;
                this.processedData = null;
                this.startTime = null;
                
                this.initializeElements();
                this.checkCompatibility();
                this.setupEventListeners();
            }

            initializeElements() {
                this.elements = {
                    fileInput: document.getElementById('fileInput'),
                    uploadSection: document.getElementById('uploadSection'),
                    processButton: document.getElementById('processButton'),
                    progressSection: document.getElementById('progressSection'),
                    progressFill: document.getElementById('progressFill'),
                    progressStatus: document.getElementById('progressStatus'),
                    progressPercent: document.getElementById('progressPercent'),
                    memoryUsed: document.getElementById('memoryUsed'),
                    memoryTotal: document.getElementById('memoryTotal'),
                    memoryFill: document.getElementById('memoryFill'),
                    processingTime: document.getElementById('processingTime'),
                    peakMemory: document.getElementById('peakMemory'),
                    errorMessage: document.getElementById('errorMessage'),
                    resultsSection: document.getElementById('resultsSection'),
                    downloadButton: document.getElementById('downloadButton'),
                    originalSize: document.getElementById('originalSize'),
                    processedSize: document.getElementById('processedSize'),
                    compressionRatio: document.getElementById('compressionRatio'),
                    finalProcessingTime: document.getElementById('finalProcessingTime'),
                    finalPeakMemory: document.getElementById('finalPeakMemory')
                };
            }

            async checkCompatibility() {
                const compatibility = BrowserMediaUtils.checkCompatibility();
                const resultsDiv = document.getElementById('compatibilityResults');
                
                resultsDiv.innerHTML = `
                    <div class="compatibility-item">
                        <div class="compatibility-icon ${compatibility.webAssembly ? 'compatible' : 'incompatible'}">
                            ${compatibility.webAssembly ? '‚úì' : '‚úó'}
                        </div>
                        <span>WebAssembly Support</span>
                    </div>
                    <div class="compatibility-item">
                        <div class="compatibility-icon ${compatibility.sharedArrayBuffer ? 'compatible' : 'incompatible'}">
                            ${compatibility.sharedArrayBuffer ? '‚úì' : '‚úó'}
                        </div>
                        <span>SharedArrayBuffer (Threading)</span>
                    </div>
                    <div class="compatibility-item">
                        <div class="compatibility-icon ${compatibility.opfs ? 'compatible' : 'incompatible'}">
                            ${compatibility.opfs ? '‚úì' : '‚úó'}
                        </div>
                        <span>Origin Private File System</span>
                    </div>
                    <div class="compatibility-item">
                        <div class="compatibility-icon ${compatibility.webWorkers ? 'compatible' : 'incompatible'}">
                            ${compatibility.webWorkers ? '‚úì' : '‚úó'}
                        </div>
                        <span>Web Workers</span>
                    </div>
                `;

                if (!compatibility.overall) {
                    this.showError('Your browser does not support all required features. Please use a modern browser like Chrome, Firefox, or Safari.');
                }

                return compatibility.overall;
            }

            setupEventListeners() {
                // File input
                this.elements.fileInput.addEventListener('change', (e) => {
                    this.handleFileSelect(e.target.files[0]);
                });

                // Drag and drop
                this.elements.uploadSection.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    this.elements.uploadSection.classList.add('dragover');
                });

                this.elements.uploadSection.addEventListener('dragleave', () => {
                    this.elements.uploadSection.classList.remove('dragover');
                });

                this.elements.uploadSection.addEventListener('drop', (e) => {
                    e.preventDefault();
                    this.elements.uploadSection.classList.remove('dragover');
                    this.handleFileSelect(e.dataTransfer.files[0]);
                });

                // Process button
                this.elements.processButton.addEventListener('click', () => {
                    this.processMedia();
                });

                // Download button
                this.elements.downloadButton.addEventListener('click', () => {
                    this.downloadProcessedFile();
                });
            }

            handleFileSelect(file) {
                if (!file) return;

                this.currentFile = file;
                this.elements.processButton.disabled = false;
                this.elements.processButton.textContent = `üöÄ Process ${file.name}`;
                
                // Show file info
                this.elements.uploadSection.innerHTML = `
                    <h3>üìÅ Selected File</h3>
                    <p><strong>Name:</strong> ${file.name}</p>
                    <p><strong>Size:</strong> ${this.formatFileSize(file.size)}</p>
                    <p><strong>Type:</strong> ${file.type}</p>
                    <button class="upload-button" onclick="document.getElementById('fileInput').click()">
                        Choose Different File
                    </button>
                    <button class="upload-button" id="processButton">
                        üöÄ Process ${file.name}
                    </button>
                `;
                
                // Re-attach event listener
                document.getElementById('processButton').addEventListener('click', () => {
                    this.processMedia();
                });
            }

            async processMedia() {
                if (!this.currentFile) {
                    this.showError('Please select a file first');
                    return;
                }

                try {
                    this.startTime = performance.now();
                    this.showProgress();
                    
                    // Initialize FFmpeg
                    this.updateProgress('Initializing FFmpeg...', 10);
                    this.ffmpeg = new BrowserFFmpeg();
                    await this.ffmpeg.initialize();
                    
                    // Start memory monitoring
                    this.startMemoryMonitoring();
                    
                    // Convert file to array buffer
                    this.updateProgress('Reading file...', 20);
                    const inputData = await BrowserMediaUtils.fileToArrayBuffer(this.currentFile);
                    
                    // Get output format
                    const outputFormat = document.querySelector('input[name="outputFormat"]:checked').value;
                    
                    // Process media
                    this.updateProgress('Processing media...', 30);
                    const result = await this.ffmpeg.processMedia(inputData, outputFormat, {
                        videoBitrate: '1000k',
                        audioBitrate: '128k',
                        resolution: '1280x720',
                        fps: '30'
                    });
                    
                    this.processedData = result.data;
                    
                    // Show results
                    this.showResults(result);
                    
                } catch (error) {
                    console.error('Processing failed:', error);
                    this.showError(`Processing failed: ${error.message}`);
                } finally {
                    this.stopMemoryMonitoring();
                    if (this.ffmpeg) {
                        await this.ffmpeg.terminate();
                    }
                }
            }

            showProgress() {
                this.elements.progressSection.classList.add('active');
                this.elements.resultsSection.classList.remove('active');
                this.elements.errorMessage.classList.remove('active');
            }

            updateProgress(status, percent) {
                this.elements.progressStatus.textContent = status;
                this.elements.progressPercent.textContent = `${percent}%`;
                this.elements.progressFill.style.width = `${percent}%`;
            }

            startMemoryMonitoring() {
                this.memoryInterval = setInterval(() => {
                    if (this.ffmpeg && this.ffmpeg.memoryMonitor) {
                        const usage = this.ffmpeg.memoryMonitor.getUsage();
                        const percent = (parseFloat(usage.used) / parseFloat(usage.total)) * 100;
                        
                        this.elements.memoryUsed.textContent = usage.used;
                        this.elements.memoryTotal.textContent = usage.total;
                        this.elements.memoryFill.style.width = `${percent}%`;
                        
                        // Update color based on usage
                        this.elements.memoryFill.className = 'memory-fill';
                        if (percent > 80) {
                            this.elements.memoryFill.classList.add('danger');
                        } else if (percent > 60) {
                            this.elements.memoryFill.classList.add('warning');
                        }
                        
                        // Update stats
                        this.elements.processingTime.textContent = Math.round(performance.now() - this.startTime);
                        this.elements.peakMemory.textContent = this.ffmpeg.memoryMonitor.peakUsage.toFixed(1);
                    }
                }, 1000);
            }

            stopMemoryMonitoring() {
                if (this.memoryInterval) {
                    clearInterval(this.memoryInterval);
                }
            }

            showResults(result) {
                this.elements.progressSection.classList.remove('active');
                this.elements.resultsSection.classList.add('active');
                
                const processingTime = Math.round(performance.now() - this.startTime);
                const originalSize = this.currentFile.size;
                const processedSize = result.data.length;
                const compressionRatio = ((1 - processedSize / originalSize) * 100).toFixed(1);
                
                this.elements.originalSize.textContent = this.formatFileSize(originalSize);
                this.elements.processedSize.textContent = this.formatFileSize(processedSize);
                this.elements.compressionRatio.textContent = `${compressionRatio}%`;
                this.elements.finalProcessingTime.textContent = processingTime;
                this.elements.finalPeakMemory.textContent = result.memoryUsage ? 
                    this.ffmpeg.memoryMonitor.peakUsage.toFixed(1) : '0';
                
                console.log('üìä Processing Stats:', {
                    processingTime,
                    originalSize,
                    processedSize,
                    compressionRatio,
                    peakMemory: this.ffmpeg.memoryMonitor?.peakUsage || 0
                });
            }

            downloadProcessedFile() {
                if (!this.processedData) return;
                
                const outputFormat = document.querySelector('input[name="outputFormat"]:checked').value;
                const mimeTypes = {
                    webm: 'video/webm',
                    mp4: 'video/mp4',
                    mp3: 'audio/mpeg',
                    opus: 'audio/opus'
                };
                
                const filename = `processed-${Date.now()}.${outputFormat}`;
                BrowserMediaUtils.createDownloadLink(
                    this.processedData,
                    filename,
                    mimeTypes[outputFormat]
                );
            }

            showError(message) {
                this.elements.errorMessage.textContent = message;
                this.elements.errorMessage.classList.add('active');
                
                setTimeout(() => {
                    this.elements.errorMessage.classList.remove('active');
                }, 5000);
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
        }

        // Initialize the media processor when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new MediaProcessor();
        });
    </script>
</body>
</html>